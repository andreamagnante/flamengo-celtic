<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flamengo VS Celtic</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#22c55e; --danger:#ef4444;
      --captain-red:#ef4444;   /* rosso chiaro per cap. Flamengo */
      --captain-green:#22c55e; /* verde chiaro per cap. Celtic   */
    }
    html{ scroll-behavior:smooth }
    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Noto Sans","Helvetica Neue",Arial;
      background:var(--bg); color:var(--text)
    }
    header{ padding:24px; border-bottom:1px solid #1f2937 }
    h1{ margin:0 0 6px; font-size:24px }
    .container{ max-width:1100px; margin:0 auto; padding:16px 24px 40px }
    .card{ background:var(--panel); border:1px solid #1f2937; border-radius:10px; padding:16px }
    .subtitle{ color:var(--muted); font-size:14px }
    table{ width:100%; border-collapse:collapse; font-size:14px }
    th,td{ padding:8px 10px; border-bottom:1px solid #1f2937; vertical-align:top }
    th{ text-align:left; color:var(--muted); font-weight:600 }
    .note{ color:var(--muted); font-size:12px }
    .nowrap{ white-space:nowrap }
    .wrap-words{ word-break:break-word; overflow-wrap:anywhere; }

    /* Badge squadra nelle partite */
    .badge-rossi,
    .badge-verdi{
      padding:2px 8px; border-radius:999px; font-size:12px; display:inline-block;
      border:1px solid transparent; transition:all .15s ease;
    }
    .badge-rossi{ color:#fecaca; background:#7f1d1d; }
    .badge-verdi{ color:#dcfce7; background:#064e3b; }

    /* Enfasi vincitore: pi√π lungo (padding orizzontale maggiore), bold, bordo/alone */
    .badge-rossi.winner{
      font-weight:800; padding:4px 80px;
      border-color:#ef4444; box-shadow:0 0 0 2px #ef4444 inset, 0 0 6px rgba(239,68,68,0.35);
    }
    .badge-verdi.winner{
      font-weight:800; padding:4px 80px;
      border-color:#22c55e; box-shadow:0 0 0 2px #22c55e inset, 0 0 6px rgba(34,197,94,0.30);
    }

    /* Liste giocatori: la virgola resta neutra (non colorata, non bold) */
    .players-list{ display:inline; }
    .players-list .player-chip{ display:inline; }
    .players-list .player-chip:not(:first-child)::before{
      content:", ";
      color: var(--text);
      font-weight: 400;
    }

    /* Nome base; il capitano sovrascrive questi valori con le classi dedicate */
    .player-chip .name{ font-weight:400; color: var(--text); }

    /* Capitani per squadra (solo il nome, non la virgola) */
    .captain-rossi .name{ color: var(--captain-red); font-weight:700; }
    .captain-verdi .name{ color: var(--captain-green); font-weight:700; }

    /* Badge "C" accanto al nome del capitano (stesso colore del team) */
    .badge-c{
      display:inline-block;
      margin-left:6px;
      font-size:11px;
      line-height:1;
      padding:2px 5px;
      border-radius:999px;
      border:1px solid currentColor;
      background:transparent;
      vertical-align:baseline;
      font-weight:700;
    }
    .captain-rossi .badge-c{ color: var(--captain-red); }
    .captain-verdi .badge-c{ color: var(--captain-green); }

    /* Toggle bar */
    .togglebar{
      position:sticky; top:0; z-index:50;
      background:rgba(17,24,39,0.85);
      backdrop-filter:saturate(180%) blur(6px);
      border-bottom:1px solid #1f2937
    }
    .toggle{ max-width:1100px; margin:0 auto; padding:10px 24px; display:flex; gap:8px; align-items:center; justify-content:flex-start }
    .seg{ display:inline-flex; border:1px solid #1f2937; background:#0b1220; border-radius:10px; overflow:hidden }
    .seg button{
      appearance:none; border:0; color:#e5e7eb; background:transparent;
      padding:10px 14px; cursor:pointer; font-weight:600
    }
    .seg button.active{ background:#1f2937; color:#fff }
    .section-desc{ color:var(--muted); font-size:13px; margin-bottom:12px }

    /* Una sola vista per volta */
    body.view-partite #classifica{ display:none }
    body.view-classifica #partite{ display:none }

    /* Classifica centrata */
    #classifica .wrap{ max-width:900px; margin:0 auto }

    /* Chart scorribile orizzontale (classifica) */
    #classifica .chart-scroll{
      width:100%;
      overflow-x:auto; overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      border-radius:10px; border:1px solid #1f2937; background:#0b1220;
    }
    #classifica .chart-canvas-wrap{
      height:360px;
      min-width:600px;
    }
    #classifica .chart-canvas-wrap > canvas{
      display:block; width:100% !important; height:100% !important;
    }

    /* Calendario (partite) responsive: tabella dentro wrapper scorrevole */
    .table-scroll{
      width:100%; max-width:100%;
      overflow-x:auto; overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      border-radius:8px; border:1px solid #1f2937; background:#0b1220;
    }
    .table-scroll > table{ min-width:640px; }

    /* Pie (solo in PARTITE) */
    #riepilogo-partite .pie-wrap{
      width:100%;
      max-width:520px;
      height:320px;
      border:1px solid #1f2937;
      border-radius:10px;
      background:#0b1220;
      padding:8px;
      margin-bottom:16px;
    }
    #riepilogo-partite canvas{ width:100% !important; height:100% !important; display:block; }

    /* Mobile */
    @media (max-width: 600px){
      .container{ padding: 12px 12px 28px; }
      .card{ padding: 12px; }
      th, td{ padding: 6px 8px; font-size: 13px; }
      .badge-rossi, .badge-verdi{ font-size: 11px; padding: 2px 6px; }
      .section-desc{ font-size: 12px; }
      #riepilogo-partite .pie-wrap{ height:260px; }
    }
  </style>
</head>

<!-- Default: CLASSIFICA -->
<body class="view-classifica">
  <header>
    <div class="container">
      <h1>Flamengo VS Celtic</h1>
      <div class="subtitle">Le punizioni le sbaglia solo chi ha paura di calciarle (o Massimo)</div>
    </div>
  </header>

  <div class="togglebar">
    <div class="toggle">
      <div class="seg" role="tablist" aria-label="Selettore vista">
        <button id="btnPartite" role="tab" aria-selected="false">Partite</button>
        <button id="btnClassifica" role="tab" aria-selected="true" class="active">Classifica</button>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- PARTITE (include il grafico a torta) -->
    <section class="card" id="partite" role="tabpanel" aria-labelledby="btnPartite">
      <!-- RIEPILOGO: Pie Flamengo vs Celtic (solo in Partite) -->
      <section id="riepilogo-partite" aria-label="Riepilogo vittorie">
        <h3 style="margin:0 0 8px">Riepilogo vittorie</h3>
        <div class="pie-wrap">
          <canvas id="pieVittorie" aria-label="Grafico a torta vittorie Flamengo e Celtic"></canvas>
        </div>
      </section>

      <!-- wrapper scorrevole -->
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th class="nowrap">Data</th>
              <th>Rossi</th>
              <th>Verdi</th>
              <th>Risultato</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody id="tbody-partite"></tbody>
        </table>
      </div>
    </section>

    <!-- CLASSIFICA -->
    <section class="card" id="classifica" role="tabpanel" aria-labelledby="btnClassifica">
      <div class="wrap">

        <!-- viewport scorribile -->
        <div class="chart-scroll">
          <div class="chart-canvas-wrap" id="chartWrap">
            <canvas id="chart"></canvas>
          </div>
        </div>

        <table style="margin-top:12px">
          <thead>
            <tr>
              <th>Giocatore</th>
              <th class="nowrap">Punti</th>
              <th class="nowrap">P</th>
              <th class="nowrap">V</th>
              <th class="nowrap">N</th>
              <th class="nowrap">S</th>
              <th class="nowrap">Media</th>
            </tr>
          </thead>
          <tbody id="tbody-classifica"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    /* ========== DATA iniettati dal build Python ========== */
    const DATA = {"matches": [{"data": "2025-09-08", "gol_rossi": 5, "gol_verdi": 8, "giocatori_rossi": ["Edoardo", "Massimo", "Luca", "Emilio", "Marco Broker", "*Pierpaolo", "Andrea", "Alberto"], "giocatori_verdi": ["Aldo", "*Marco G.", "Gerry", "Messi", "Marco cugino", "Fabio", "Andrea Suola", "Vincenzo"], "note": "Partita 1"}, {"data": "2025-09-15", "gol_rossi": 10, "gol_verdi": 4, "giocatori_rossi": ["Edoardo", "Massimo", "Luca", "Davide", "*Pierpaolo", "Marco cugino", "Vincenzo", "Gerry"], "giocatori_verdi": ["Aldo", "*Marco G.", "Messi", "Marco Broker", "Emilio", "Andrea", "Lorenzo", "Alberto"], "note": "Partita 2"}, {"data": "2025-09-22", "gol_rossi": 0, "gol_verdi": 6, "giocatori_rossi": ["Pierpaolo", "Luca", "Messi", "Davide", "Sandro", "Raffaele", "*Lorenzo", "Vincenzo", "Olindo"], "giocatori_verdi": ["Edoardo", "Marco G.", "Marco Broker", "Emilio", "Andrea", "Massimo", "Alberto", "Gerry", "*Andrea Suola"], "note": "Partita 3"}, {"data": "2025-09-29", "gol_rossi": 6, "gol_verdi": 8, "giocatori_rossi": ["Aldo", "Luca", "Marco Broker", "Emilio", "Raffaele", "*Lorenzo", "Vincenzo", "Olindo"], "giocatori_verdi": ["Edoardo", "Andrea terzino", "Davide", "Andrea", "Massimo", "Alberto", "Gerry", "*Andrea Suola"], "note": "Partita 4"}, {"data": "2025-10-06", "gol_rossi": 6, "gol_verdi": 1, "giocatori_rossi": ["Massimo", "Marco Broker", "Emilio", "Davide", "Andrea Suola", "Andrea terzino", "*Vincenzo", "Alberto"], "giocatori_verdi": ["Dimitri", "*Andrea", "Luca", "Messi", "Olindo", "Lorenzo", "Raffaele", "Gerry"], "note": "Partita 5"}, {"data": "2025-10-13", "gol_rossi": 1, "gol_verdi": 6, "giocatori_rossi": ["Dimitri", "*Luca", "Emilio", "Marco Broker", "Andrea", "Andrea terzino", "Olindo", "Alberto"], "giocatori_verdi": ["Edoardo", "*Messi", "Gerry", "Massimo", "Pierpaolo", "Andrea Suola", "Marco G.", "Peppe"], "note": "Partita 6"}, {"data": "2025-10-20", "gol_rossi": 7, "gol_verdi": 4, "giocatori_rossi": ["Edoardo", "Raffaele", "Marco G.", "Luca", "Olindo", "Andrea terzino", "*Vincenzo", "Alberto"], "giocatori_verdi": ["Otello", "Massimo", "Marco Broker", "Emilio", "*Andrea", "Lorenzo amico Andrea", "Andrea Suola", "Gerry"], "note": "Partita 7"}, {"data": "2025-10-27", "gol_rossi": 7, "gol_verdi": 1, "giocatori_rossi": ["Edoardo", "*Luca", "Sandro", "Massimo", "Marco G.", "Vincenzo", "Lorenzo", "Peppe"], "giocatori_verdi": ["Otello", "*Messi", "Gerry", "Emilio", "Marco Broker", "Andrea Suola", "Andrea", "Alberto"], "note": "Partita 8"}, {"data": "2025-11-03", "gol_rossi": 4, "gol_verdi": 6, "giocatori_rossi": ["Otello", "Luca", "*Marco Broker", "Aldo", "Francesco (andrea)", "Vincenzo", "Lorenzo", "Gerry"], "giocatori_verdi": ["Edoardo", "Emilio", "*Raffaele", "Massimo", "Andrea terzino", "Andrea Suola", "Andrea", "Olindo"], "note": "Partita 9"}, {"data": "2025-11-10", "gol_rossi": 8, "gol_verdi": 5, "giocatori_rossi": ["Marco G.", "*Marco Broker", "Emilio", "Massimo", "Andrea", "Andrea terzino", "Alberto", "Cristiano (amico Luca)"], "giocatori_verdi": ["Otello", "*Raffaele", "Gerry", "Luca", "Peppe", "Luca (amico Peppe)", "Vincenzo", "Olindo"], "note": "Partita 10"}, {"data": "2025-11-17", "gol_rossi": 4, "gol_verdi": 4, "giocatori_rossi": ["Alessio portiere", "Emilio", "Raffaele", "Andrea", "Andrea terzino", "Cristiano (amico Luca)", "*Gerry", "Olindo"], "giocatori_verdi": ["Edoardo", "*Massimo", "Luca", "Davide meccanico", "Marco Broker", "Marco G.", "Lorenzo", "Alberto"], "note": "Partita 11"}, {"data": "2025-12-01", "gol_rossi": 3, "gol_verdi": 4, "giocatori_rossi": ["Edoardo", "Marco G.", "*Sandro", "Massimo", "Andrea Suola", "Vincenzo", "Peppe", "Luca"], "giocatori_verdi": ["Sorin", "Raffaele", "*Emilio", "Marco Broker", "Alberto", "Messi", "Andrea", "Cristiano"], "note": "Partita 12"}, {"data": "2025-12-09", "gol_rossi": 3, "gol_verdi": 4, "giocatori_rossi": ["Otello", "Raffaele", "Davide meccanico", "Massimo", "Vincenzo", "*Peppe", "Luca", "Pierpaolo"], "giocatori_verdi": ["Sorin", "Emilio", "Marco Broker", "*Alberto", "Messi", "Fabio", "Andrea", "Andrea Suola"], "note": "Partita 13"}, {"data": "2025-12-15", "gol_rossi": 8, "gol_verdi": 6, "giocatori_rossi": ["*Edoardo", "Raffaele", "Emilio", "Cristiano", "Andrea Suola", "Vincenzo", "Peppe"], "giocatori_verdi": ["*Sorin", "Massimo", "Marco Broker", "Andrea terzino", "Bogdan", "Luca di Peppe", "Francesco di Suola"], "note": "Partita 14"}, {"data": "2025-12-22", "gol_rossi": 0, "gol_verdi": 0, "giocatori_rossi": ["Edoardo", "Massimo", "Davide meccanico", "Antonio (Davide Meccanico)", "Andrea terzino", "Luca", "Alberto", "Peppe"], "giocatori_verdi": ["Otello", "Gerry", "figlio di Gerry", "Vincenzo", "Figlio di Vincenzo", "Andrea Suola", "Francesco di Suola", "Luca Suola"], "note": "Partita 15"}, {"data": "2026-01-12", "gol_rossi": 4, "gol_verdi": 2, "giocatori_rossi": ["*Sorin", "Gerry", "Davide Meccanico", "Giordano Suola", "Luca Suola", "Andrea Suola", "Vincenzo", "Alberto"], "giocatori_verdi": ["*Edoardo", "Massimo", "Emilio", "Andrea terzino", "Luca", "Cristiano", "Massimiliano di Cristiano", "Marco Davide Meccancio"], "note": "Partita 16"}, {"data": "2026-01-19", "gol_rossi": 9, "gol_verdi": 4, "giocatori_rossi": ["Sorin", "*Massimo", "Luca Suola", "Andrea terzino", "Andrea Suola", "Vincenzo", "Francesco Suola"], "giocatori_verdi": ["Edoardo", "Emilio", "Aldo", "Alberto", "*Gerry", "Bogdan", "Marco Broker"], "note": "Partita 17"}, {"data": "2026-01-26", "gol_rossi": 4, "gol_verdi": 4, "giocatori_rossi": ["Edoardo", "Emilio", "Luca Suola", "Massimo", "Bodgan", "*Luca", "Cristiano", "Alberto"], "giocatori_verdi": ["Sorin", "*Andrea Suola", "Andrea terzino", "Gerry", "Aldo", "Davide Meccanico", "Marco Luca", "Andrea"], "note": "Partita 18 - flamengo vs celtic"}], "table": [{"giocatore": "Massimo", "punti": 26, "P": 16, "V": 8, "N": 2, "S": 6}, {"giocatore": "Andrea Suola", "punti": 25, "P": 12, "V": 8, "N": 1, "S": 3}, {"giocatore": "Alberto", "punti": 24, "P": 15, "V": 7, "N": 3, "S": 5}, {"giocatore": "Edoardo", "punti": 24, "P": 13, "V": 7, "N": 3, "S": 3}, {"giocatore": "Andrea terzino", "punti": 21, "P": 12, "V": 6, "N": 3, "S": 3}, {"giocatore": "Andrea", "punti": 20, "P": 12, "V": 6, "N": 2, "S": 4}, {"giocatore": "Emilio", "punti": 20, "P": 16, "V": 6, "N": 2, "S": 8}, {"giocatore": "Gerry", "punti": 20, "P": 13, "V": 6, "N": 2, "S": 5}, {"giocatore": "Vincenzo", "punti": 19, "P": 13, "V": 6, "N": 1, "S": 6}, {"giocatore": "Marco G.", "punti": 16, "P": 7, "V": 5, "N": 1, "S": 1}, {"giocatore": "Marco Broker", "punti": 13, "P": 13, "V": 4, "N": 1, "S": 8}, {"giocatore": "Peppe", "punti": 10, "P": 6, "V": 3, "N": 1, "S": 2}, {"giocatore": "Raffaele", "punti": 10, "P": 8, "V": 3, "N": 1, "S": 4}, {"giocatore": "Sorin", "punti": 10, "P": 4, "V": 3, "N": 1, "S": 0}, {"giocatore": "Davide", "punti": 9, "P": 4, "V": 3, "N": 0, "S": 1}, {"giocatore": "Messi", "punti": 9, "P": 6, "V": 3, "N": 0, "S": 3}, {"giocatore": "Luca", "punti": 8, "P": 13, "V": 2, "N": 2, "S": 9}, {"giocatore": "Luca Suola", "punti": 8, "P": 4, "V": 2, "N": 2, "S": 0}, {"giocatore": "*Andrea Suola", "punti": 7, "P": 3, "V": 2, "N": 1, "S": 0}, {"giocatore": "Cristiano", "punti": 7, "P": 4, "V": 2, "N": 1, "S": 1}, {"giocatore": "Olindo", "punti": 7, "P": 8, "V": 2, "N": 1, "S": 5}, {"giocatore": "*Vincenzo", "punti": 6, "P": 2, "V": 2, "N": 0, "S": 0}, {"giocatore": "Fabio", "punti": 6, "P": 2, "V": 2, "N": 0, "S": 0}, {"giocatore": "Marco cugino", "punti": 6, "P": 2, "V": 2, "N": 0, "S": 0}, {"giocatore": "*Luca", "punti": 4, "P": 3, "V": 1, "N": 1, "S": 1}, {"giocatore": "*Massimo", "punti": 4, "P": 2, "V": 1, "N": 1, "S": 0}, {"giocatore": "Aldo", "punti": 4, "P": 6, "V": 1, "N": 1, "S": 4}, {"giocatore": "Cristiano (amico Luca)", "punti": 4, "P": 2, "V": 1, "N": 1, "S": 0}, {"giocatore": "Davide Meccanico", "punti": 4, "P": 2, "V": 1, "N": 1, "S": 0}, {"giocatore": "Lorenzo", "punti": 4, "P": 5, "V": 1, "N": 1, "S": 3}, {"giocatore": "*Alberto", "punti": 3, "P": 1, "V": 1, "N": 0, "S": 0}, {"giocatore": "*Edoardo", "punti": 3, "P": 2, "V": 1, "N": 0, "S": 1}, {"giocatore": "*Emilio", "punti": 3, "P": 1, "V": 1, "N": 0, "S": 0}, {"giocatore": "*Marco Broker", "punti": 3, "P": 2, "V": 1, "N": 0, "S": 1}, {"giocatore": "*Marco G.", "punti": 3, "P": 2, "V": 1, "N": 0, "S": 1}, {"giocatore": "*Messi", "punti": 3, "P": 2, "V": 1, "N": 0, "S": 1}, {"giocatore": "*Pierpaolo", "punti": 3, "P": 2, "V": 1, "N": 0, "S": 1}, {"giocatore": "*Raffaele", "punti": 3, "P": 2, "V": 1, "N": 0, "S": 1}, {"giocatore": "*Sorin", "punti": 3, "P": 2, "V": 1, "N": 0, "S": 1}, {"giocatore": "Francesco Suola", "punti": 3, "P": 1, "V": 1, "N": 0, "S": 0}, {"giocatore": "Giordano Suola", "punti": 3, "P": 1, "V": 1, "N": 0, "S": 0}, {"giocatore": "Pierpaolo", "punti": 3, "P": 3, "V": 1, "N": 0, "S": 2}, {"giocatore": "Sandro", "punti": 3, "P": 2, "V": 1, "N": 0, "S": 1}, {"giocatore": "Davide meccanico", "punti": 2, "P": 3, "V": 0, "N": 2, "S": 1}, {"giocatore": "*Gerry", "punti": 1, "P": 2, "V": 0, "N": 1, "S": 1}, {"giocatore": "Alessio portiere", "punti": 1, "P": 1, "V": 0, "N": 1, "S": 0}, {"giocatore": "Antonio (Davide Meccanico)", "punti": 1, "P": 1, "V": 0, "N": 1, "S": 0}, {"giocatore": "Bodgan", "punti": 1, "P": 1, "V": 0, "N": 1, "S": 0}, {"giocatore": "figlio di Gerry", "punti": 1, "P": 1, "V": 0, "N": 1, "S": 0}, {"giocatore": "Figlio di Vincenzo", "punti": 1, "P": 1, "V": 0, "N": 1, "S": 0}, {"giocatore": "Francesco di Suola", "punti": 1, "P": 2, "V": 0, "N": 1, "S": 1}, {"giocatore": "Marco Luca", "punti": 1, "P": 1, "V": 0, "N": 1, "S": 0}, {"giocatore": "Otello", "punti": 1, "P": 6, "V": 0, "N": 1, "S": 5}]};

    /* ========== utilit√† DOM ========== */
    function el(tag, attrs={}, children=[]){
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==='class') e.className=v;
        else if(k==='html') e.innerHTML=v;
        else e.setAttribute(k,v);
      });
      children.forEach(c=>e.appendChild(c));
      return e;
    }

    /* Etichette su 2 righe (spezzate al primo spazio) per leggibilit√† */
    function wrapLabel(name){
      if(!name) return name;
      const s = String(name);
      const i = s.indexOf(' ');
      if(i>0) return [s.slice(0,i), s.slice(i+1)];
      return s;
    }

    /* Normalizza nome (rimuove asterischi ai lati) + rileva capitano per formazioni */
    function normalizePlayer(raw){
      let s = String(raw ?? '').trim();
      const hasLeadingStar = /^\s*\*+/.test(s);
      const hasTrailingStar = /\*+\s*$/.test(s);
      const isCaptain = hasLeadingStar || hasTrailingStar;
      s = s.replace(/^\s*\*+\s*/, '').replace(/\s*\*+\s*$/, '');
      return { name: s, isCaptain };
    }
    function normalizeNameKey(name){
      return String(name ?? '').trim().replace(/^\s*\*+\s*/, '').replace(/\s*\*+\s*$/, '');
    }

    /* Lista giocatori inline con badge capitano per team */
    function playersFragment(list, team /* 'rossi' | 'verdi' */){
      const container = document.createElement('span');
      container.className = 'players-list';
      (list || []).forEach(raw => {
        const { name, isCaptain } = normalizePlayer(raw);

        const chip = document.createElement('span');
        chip.className = 'player-chip' + (isCaptain ? (team === 'rossi' ? ' captain-rossi' : ' captain-verdi') : '');

        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        nameSpan.textContent = name;
        chip.appendChild(nameSpan);

        if (isCaptain) {
          const badge = document.createElement('span');
          badge.className = 'badge-c';
          badge.setAttribute('title', 'Capitano');
          badge.setAttribute('aria-label', 'Capitano');
          badge.textContent = 'C';
          chip.appendChild(badge);
        }

        container.appendChild(chip);
      });
      return container;
    }

    /* ========== Aggrega CLASSIFICA su nomi normalizzati (unifica *Nome e Nome) ========== */
    function aggregateTable(rawTable){
      const map = new Map();
      (rawTable || []).forEach(r => {
        const key = normalizeNameKey(r.giocatore);
        const cur = map.get(key) || { giocatore: key, punti:0, P:0, V:0, N:0, S:0 };
        cur.punti += Number(r.punti) || 0;
        cur.P     += Number(r.P)     || 0;
        cur.V     += Number(r.V)     || 0;
        cur.N     += Number(r.N)     || 0;
        cur.S     += Number(r.S)     || 0;
        map.set(key, cur);
      });
      // Ordina per punti desc poi nome asc
      return Array.from(map.values()).sort((a,b)=> (b.punti - a.punti) || a.giocatore.localeCompare(b.giocatore));
    }

    /* ========== PARTITE (tabella) ========== */
    function renderPartite(matches){
      const tbody = document.getElementById('tbody-partite');
      tbody.innerHTML = '';
      (matches || []).forEach(m => {
        const r = Number(m.gol_rossi) || 0;
        const v = Number(m.gol_verdi) || 0;
        const res = `${r} - ${v}`;
        const winnerTeam = r > v ? 'rossi' : (v > r ? 'verdi' : null);

        // Rossi
        const tdRossi = el('td',{class:'wrap-words'});
        const badgeRossi = el(
          'div',
          { class: 'badge-rossi' + (winnerTeam==='rossi' ? ' winner' : '') },
          [document.createTextNode('Rossi')]
        );
        tdRossi.appendChild(badgeRossi);
        tdRossi.appendChild(document.createElement('br'));
        tdRossi.appendChild(playersFragment(m.giocatori_rossi || [], 'rossi'));

        // Verdi
        const tdVerdi = el('td',{class:'wrap-words'});
        const badgeVerdi = el(
          'div',
          { class: 'badge-verdi' + (winnerTeam==='verdi' ? ' winner' : '') },
          [document.createTextNode('Verdi')]
        );
        tdVerdi.appendChild(badgeVerdi);
        tdVerdi.appendChild(document.createElement('br'));
        tdVerdi.appendChild(playersFragment(m.giocatori_verdi || [], 'verdi'));

        const tr = el('tr',{},[
          el('td',{class:'nowrap'},[document.createTextNode(m.data)]),
          tdRossi,
          tdVerdi,
          el('td',{html:`<strong>${res}</strong>`}),
          el('td',{class:'note'},[document.createTextNode(m.note || '')]),
        ]);
        tbody.appendChild(tr);
      });
    }

    /* ========== CLASSIFICA (tabellina) ========== */
    function renderClassifica(table){
      const tbody = document.getElementById('tbody-classifica');
      tbody.innerHTML = '';
      (table || []).forEach(r => {
        const P = Number(r.P) || 0;
        const punti = Number(r.punti) || 0;
        const media = P > 0 ? (punti / P) : 0;
        const tr = el('tr',{},[
          el('td',{},[document.createTextNode(r.giocatore)]),
          el('td',{},[document.createTextNode(punti)]),
          el('td',{},[document.createTextNode(P)]),
          el('td',{},[document.createTextNode(r.V)]),
          el('td',{},[document.createTextNode(r.N)]),
          el('td',{},[document.createTextNode(r.S)]),
          el('td',{},[document.createTextNode(media.toFixed(2))]),
        ]);
        tbody.appendChild(tr);
      });
    }

    /* ========== Plugin CORONCINA sui leader ========== */
    const crownPlugin = {
      id: 'crown',
      afterDatasetsDraw(chart) {
        const leaders = (chart.options && chart.options.plugins && chart.options.plugins.crown && chart.options.plugins.crown.leaders) || [];
        if (!leaders.length) return;
        const { ctx } = chart;
        const meta = chart.getDatasetMeta(0);
        leaders.forEach(idx => {
          const bar = meta.data[idx];
          if (!bar) return;
          const { x, y } = bar.getProps(['x','y'], true);
          ctx.save();
          ctx.font = '16px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';
          ctx.fillText('üëë', x, y - 6);
          ctx.restore();
        });
      }
    };

    /* ========== GRAFICO CLASSIFICA (scorribile) ========== */
    function renderChart(table){
      const labels = (table || []).map(r => r.giocatore);         // gi√† normalizzati (senza *)
      const points = (table || []).map(r => r.punti);
      const wrap = document.getElementById('chartWrap');
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');

      const avgNameLen = labels.reduce((s, n) => s + String(n).length, 0) / Math.max(1, labels.length);
      const basePerLabel = 70;
      const extraByLen = Math.min(40, Math.max(0, avgNameLen - 10) * 2);
      const extraByCount = labels.length > 20 ? 20 : (labels.length > 12 ? 10 : 0);
      const perLabelWidth = basePerLabel + extraByLen + extraByCount;

      const totalWidth = Math.max(600, Math.round(perLabelWidth * labels.length));
      wrap.style.width = totalWidth + 'px';

      const maxPts = Math.max(...points);
      const leaders = points.reduce((acc, p, i) => { if (p === maxPts) acc.push(i); return acc; }, []);
      const GOLD_BG = 'rgba(255,215,0,0.85)';
      const GOLD_BR = 'rgba(255,215,0,1)';
      const GREEN_BG = 'rgba(184,127,94,0.6)';
      const GREEN_BR = 'rgba(184,127,94,1)';
      const bg = points.map(p => p === maxPts ? GOLD_BG : GREEN_BG);
      const br = points.map(p => p === maxPts ? GOLD_BR : GREEN_BR);

      if (window.__rvvChart) { window.__rvvChart.destroy(); }

      window.__rvvChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels.map(wrapLabel),
          datasets: [{
            label: 'Punti',
            data: points,
            backgroundColor: bg,
            borderColor: br,
            borderWidth: 1.5,
          }],
        },
        options: {
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true },
            crown: { leaders },
          },
          scales: {
            x: {
              ticks: {
                color: '#e5e7eb',
                maxRotation: 45,
                minRotation: 20,
                autoSkip: false,
                font: { size: labels.length > 24 ? 10 : 12 },
              },
              grid: { color: '#1f2937' },
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb' },
              grid: { color: '#1f2937' },
            },
          },
          layout: { padding: 6 },
        },
        plugins: [crownPlugin],
      });
    }

    /* ========== PIE VITTORIE: Modalit√† B (crea/distruggi al cambio tab) ========== */
    function countWins(matches){
      let flamengoWins = 0, celticWins = 0;
      (matches || []).forEach(m => {
        const r = Number(m.gol_rossi) || 0;
        const v = Number(m.gol_verdi) || 0;
        if (r > v) flamengoWins++;
        else if (v > r) celticWins++;
      });
      return { flamengoWins, celticWins };
    }

    function createPieVittorie(matches){
      const ctxEl = document.getElementById('pieVittorie');
      if (!ctxEl) return;
      const { flamengoWins, celticWins } = countWins(matches);

      const ctx = ctxEl.getContext('2d');
      window.__pieVittorie = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: [`Flamengo (${flamengoWins})`, `Celtic (${celticWins})`],
          datasets: [{
            data: [flamengoWins, celticWins],
            backgroundColor: ['#ef4444', '#22c55e'],
            borderColor: ['#b91c1c', '#14532d'],
            borderWidth: 1.5,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#e5e7eb' } },
            tooltip: { enabled: true },
          }
        }
      });
    }
    function destroyPieVittorie(){
      if (window.__pieVittorie){
        window.__pieVittorie.destroy();
        window.__pieVittorie = null;
      }
    }

    /* ========== INIT ========== */
    // Aggrega la classifica su nomi normalizzati (unifica *Nome e Nome)
    const TABLE = aggregateTable(DATA.table);

    renderPartite(DATA.matches);
    renderClassifica(TABLE);
    renderChart(TABLE);
    // Non creiamo il pie qui (vista iniziale "classifica")

    // Toggle viste (Modalit√† B: pie solo in Partite)
    const body = document.body;
    const bPartite = document.getElementById('btnPartite');
    const bClassifica = document.getElementById('btnClassifica');

    function setView(view){
      if(view==='partite'){
        body.classList.add('view-partite');
        body.classList.remove('view-classifica');
        bPartite.classList.add('active'); bPartite.setAttribute('aria-selected','true');
        bClassifica.classList.remove('active'); bClassifica.setAttribute('aria-selected','false');

        // Crea il pie SOLO ora
        if (!window.__pieVittorie) createPieVittorie(DATA.matches);

      } else {
        body.classList.add('view-classifica');
        body.classList.remove('view-partite');
        bClassifica.classList.add('active'); bClassifica.setAttribute('aria-selected','true');
        bPartite.classList.remove('active'); bPartite.setAttribute('aria-selected','false');

        // Distruggi il pie (cos√¨ non appare mai sopra la classifica)
        destroyPieVittorie();
      }
    }

    bPartite.addEventListener('click', () => setView('partite'));
    bClassifica.addEventListener('click', () => setView('classifica'));
    // Default gi√† su "classifica" (classe del <body>)
  </script>
</body>
</html>
``